version: '3.8'
services:
  chat:
    image: neelkamath/omni-chat:0.7.2
    entrypoint: /dockerize -wait tcp://db:5432 -wait tcp://message-broker:6379
    command: java -server -jar omni-chat-all.jar
    networks: [ broker, db, proxy ]
    expose: [ 80 ]
    restart: unless-stopped
    environment:
      APP_NAME: ${APP_NAME}
      JWT_SECRET: ${JWT_SECRET}
      POSTGRES_DB: postgres
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: ${DB_PASSWORD}
      POSTGRES_URL: db:5432
      REDIS_URL: redis://message-broker:6379
      ALLOWED_DOMAINS: ${ALLOWED_DOMAINS}
      SMTP_HOST: ${SMTP_HOST}
      SMTP_TLS_PORT: ${SMTP_TLS_PORT}
      SMTP_FROM: ${SMTP_FROM}
      SMTP_USERNAME: ${SMTP_USERNAME}
      SMTP_PASSWORD: ${SMTP_PASSWORD}
    volumes:
      - type: bind
        source: ./dockerize
        target: /dockerize
        read_only: true
  db:
    image: postgres:12.4
    restart: unless-stopped
    expose: [ 5432 ]
    networks: [ db ]
    environment:
      POSTGRES_PASSWORD: ${DB_PASSWORD}
    volumes:
      - type: volume
        source: db
        target: /var/lib/postgresql/data
  message-broker:
    image: redis:6.0.8
    restart: unless-stopped
    expose: [6379]
    networks: [broker]
    sysctls:
      net.core.somaxconn: 511
  proxy:
    image: caddy:2.1.1
    networks: [proxy]
    expose: [80, 443, 2019]
    ports: [80:80, 443:443]
    restart: unless-stopped
    volumes:
      - type: bind
        source: ./Caddyfile
        target: /etc/caddy/Caddyfile
        read_only: true
      - type: volume
        source: caddy-config
        target: /config
      - type: volume
        source: caddy-data
        target: /data
volumes:
  caddy-config:
  caddy-data:
  db:
networks:
  broker:
  db:
  proxy:
